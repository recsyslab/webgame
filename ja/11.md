---
title: モデルの定義
layout: default
---

{% include header.html %}

{% raw %}

# モデルの定義

スコア管理に必要なデータをモデルクラスとして定義していきます。モデルクラスは、`webgame/online/models.py`に記述します。ここでは、スコア管理に必要なスコアテーブルを下記のように設計することにします。

スコアテーブル
<table>
    <tr><th>カラム名</th><th>説明</th><th>データ型</th><th>制約</th></tr>
    <tr><td>id</td><td>スコアID</td><td>INT</td><td>PRIMARY KEY</td></tr>
    <tr><td>player_name</td><td>プレイや名</td><td>VARCHAR(20)</td><td>NOT NULL</td></tr>
    <tr><td>score</td><td>スコア</td><td>INT</td><td>NOT NULL</td></tr>
    <tr><td>achieved_at</td><td>達成日時</td><td>TIMESTAMP</td><td>NOT NULL</td></tr>
</table>

以上を基に、モデルクラスを定義します。`webgame/online/models.py`に下記のコードを記述してください。

リスト1: `webgame/online/models.py`
```py
from django.db import models


class Score(models.Model):
    """スコアモデル
    Attributes
    ----------
    id : IntegerField
        スコアID
    player_name : CharField
        プレイや名
    score : IntegerField
        スコア
    achieved_at : DateTimeField
        達成日時
    """
    player_name = models.CharField(verbose_name='プレイヤ名', max_length=20)
    score = models.IntegerField(verbose_name='スコア')
    achieved_at = models.DateTimeField(verbose_name='達成日時', auto_now_add=True)
 
    class Meta:
        verbose_name_plural = 'スコア'
 
    def __str__(self):
        return str(self.player_name + ":" + str(self.score))
```

`online/models.py`では`django.db.models.Model`クラスを継承したスコアモデル`Score`を定義しています。

テーブルのカラムはモデルクラスのクラス属性として定義します。例えば、`Score`クラスには`player_name`を定義しています。このクラス属性は`Field`クラスのインスタンスとして定義します。`CharField`は文字フィールドを表します。`Field`クラスの`verbose_name`にはそのフィールドの説明を表す人間可読なフィールド名を指定します。また、`CharField`には`max_length`を指定する必要があります。これは、このカラムに登録できる最大文字数を表します。

なお、テーブル設計時には主キーとして`id`を用意していましたが、`Score`クラスでは主キーに対応するフィールドを定義していません。主キーフィールドの定義を省略すると、自動的に`id`という名前で主キーフィールドが追加されます。

モデルについては、文献[1][2]を参照してください。

モデルの準備ができましたので、マイグレーションを実行します。まず、下記のコマンドでマイグレーションファイルを作成します。

```bash
(rsl-webgame) $ export DB_USER=rsl
(rsl-webgame) $ export DB_PASSWORD=【パスワード】
(rsl-webgame) $ python manage.py makemigrations online
Migrations for 'online':
  online/migrations/0001_initial.py
    - Create model Score
```

`webgame/online/migrations/`ディレクトリに`0001_initial.py`が作成されました。この時点ではまだマイグレーションは実行されていません。マイグレーションを実行することで、このマイグレーションファイルの内容がデータベースに適用されることになります。下記のコマンドでマイグレーションが実行する内容を確認してみましょう。

```bash
(rsl-webgame) $ python manage.py sqlmigrate online 0001
BEGIN;
--
-- Create model Score
--
CREATE TABLE "online_score" ("id" bigint NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY, "player_name" varchar(20) NOT NULL, "score" integer NOT NULL, "achieved_at" timestamp with time zone NOT NULL);
COMMIT;
```

このようにSQLが出力されました。マイグレーションはこのSQLを実行するということになります。では、マイグレーションを実行してみましょう。

```bash
(rsl-webgame) $ python manage.py migrate
Operations to perform:
  Apply all migrations: accounts, admin, auth, contenttypes, online, sessions
Running migrations:
  Applying online.0001_initial... OK
```

PostgreSQL上で、テーブルを確認してください。

```pgsql
webgame=# \dt
                       List of relations
 Schema |                 Name                 | Type  | Owner
--------+--------------------------------------+-------+-------
...（略）...
 public | online_score                         | table | rsl
(11 rows)
```

`online_scoreテーブルが作成されていることが確認できます。このように、テーブル名には自動的に「<アプリケーション名>_<モデルのクラス名>」が付けられます。もし、好きなテーブル名を設定したい場合には、リスト1のモデルクラス内の`Meta`クラスに`db_table`属性を指定します。

テーブルの定義も確認してみましょう。

```pgsql
webgame=# \d online_score
                                   Table "public.online_score"
   Column    |           Type           | Collation | Nullable |             Default
-------------+--------------------------+-----------+----------+----------------------------------
 id          | bigint                   |           | not null | generated by default as identity
 player_name | character varying(20)    |           | not null |
 score       | integer                  |           | not null |
 achieved_at | timestamp with time zone |           | not null |
Indexes:
    "online_score_pkey" PRIMARY KEY, btree (id)
```

このようにテーブル設計したとおりの列が定義されていることがわかります。

マイグレーションの詳細は文献[2][3]を参照してください。

#### 参考
1. [はじめての Django アプリ作成、その2 \| Django ドキュメント \| Django # モデルの作成](https://docs.djangoproject.com/ja/4.1/intro/tutorial02/#creating-models)
1. 現場で使える Django の教科書《基礎編》 # 第6章 モデル (Model)
1. 現場で使える Django の教科書《基礎編》 # 第11章 データベースのマイグレーション

{% endraw %}
