---
title: モデルの定義
layout: default
---

{% include header.html %}

{% raw %}

# モデルの定義

スコア管理に必要なデータをモデルクラスとして定義していきます。モデルクラスは、`webgame/online/models.py`に記述します。ここでは、スコア管理に必要なスコアテーブルを下記のように設計することにします。

スコアテーブル
<table>
    <tr><th>カラム名</th><th>説明</th><th>データ型</th><th>制約</th></tr>
    <tr><td>id</td><td>スコアID</td><td>INT</td><td>PRIMARY KEY</td></tr>
    <tr><td>player_name</td><td>プレイや名</td><td>VARCHAR(20)</td><td>NOT NULL</td></tr>
    <tr><td>score</td><td>スコア</td><td>INT</td><td>NOT NULL</td></tr>
    <tr><td>achieved_at</td><td>達成日時</td><td>TIMESTAMP</td><td>NOT NULL</td></tr>
</table>

以上を基に、モデルクラスを定義します。`webgame/online/models.py`に下記のコードを記述してください。

リスト1: `webgame/online/models.py`
```py
from django.db import models


class Score(models.Model):
    """スコアモデル
    Attributes
    ----------
    id : IntegerField
        スコアID
    player_name : CharField
        プレイや名
    score : IntegerField
        スコア
    achieved_at : DateTimeField
        達成日時
    """
    player_name = models.CharField(verbose_name='プレイヤ名', max_length=20)
    score = models.IntegerField(verbose_name='スコア')
    achieved_at = models.DateTimeField(verbose_name='達成日時', auto_now_add=True)
 
    class Meta:
        verbose_name_plural = 'スコア'
 
    def __str__(self):
        return str(self.player_name + ":" + str(self.score))
```

`online/models.py`では`django.db.models.Model`クラスを継承した各モデルを定義しています。ユーザモデル、アイテムモデル、評価値モデルは、それぞれ`User`、`Item`、`Rating`クラスとして定義しています。また、各推薦リストモデルは`Reclist*`クラスとして定義しています。

テーブルのカラムはモデルクラスのクラス属性として定義します。例えば、`User`クラスには`name`を定義しています。このクラス属性は`Field`クラスのインスタンスとして定義します。`TextField`はテキストフィールドを表します。必要に応じて、`blank`や`null`などの`Field`クラスのフィールドオプションを指定します。なお、ユーザテーブルとアイテムテーブルにおいては、それぞれ`user_id`、`item_id`のカラムを主キーとして設定しました。これらに対応して、`User`モデルと`Item`モデルでは、それぞれに対応するフィールドとして`user_id`、`item_id`のフィールドオプションに`primary_key=True`を設定しています。一方で、`Rating`モデルや`Reclist*`モデルにおいては、明示的には主キーに対応するフィールドを定義していません。主キーフィールドの定義を省略すると、自動的に`id`という名前で主キーフィールドが追加されます。

モデルについては、文献[1][2]を参照してください。

モデルの準備ができましたので、マイグレーションを実行します。まず、下記のコマンドでマイグレーションファイルを作成します。

```bash
(rsl-django) $ python manage.py makemigrations online
Migrations for 'online':
  online/migrations/0001_initial.py
    - Create model Item
    - Create model Rating
    - Create model ReclistItemcf
    - Create model ReclistPopularity
    - Create model ReclistSimilarity
    - Create model User
```

`recsys_django/online/migrations/`ディレクトリに`0001_initial.py`が作成されました。下記のコマンドでマイグレーションが実行する内容を確認してみましょう。

```bash
(rsl-django) $ python manage.py sqlmigrate online 0001
BEGIN;
--
-- Create model Item
--
--
-- Create model Rating
--
--
-- Create model ReclistItemcf
--
--
-- Create model ReclistPopularity
--
--
-- Create model ReclistSimilarity
--
--
-- Create model User
--
COMMIT;
```

このようにSQLが出力されました。ただし、今回はいずれも既にテーブルを作成済みですので、マイグレーションにより新規にテーブルが作成されることはありません。では、マイグレーションを実行してみましょう。

```bash
(rsl-django) $ python manage.py migrate
Operations to perform:
  Apply all migrations: accounts, admin, auth, contenttypes, online, sessions
Running migrations:
  Applying online.0001_initial... OK
```

マイグレーションの詳細は文献[2][3]を参照してください。

#### 参考
1. [はじめての Django アプリ作成、その2 \| Django ドキュメント \| Django # モデルの作成](https://docs.djangoproject.com/ja/4.1/intro/tutorial02/#creating-models)
1. 現場で使える Django の教科書《基礎編》 # 第6章 モデル (Model)
1. 現場で使える Django の教科書《基礎編》 # 第11章 データベースのマイグレーション

{% endraw %}



```bash
(rsl-webgame) $ export DB_USER=rsl
(rsl-webgame) $ export DB_PASSWORD=【パスワード】
(rsl-webgame) $ python manage.py inspectdb
```

